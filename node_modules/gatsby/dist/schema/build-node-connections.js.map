{"version":3,"sources":["../../src/schema/build-node-connections.js"],"names":["_","require","connectionArgs","connectionDefinitions","GraphQLInputObjectType","inferInputObjectStructureFromNodes","inferInputObjectStructureFromFields","createSortField","buildConnectionFields","createPageDependency","connectionFromArray","runQuery","handleQueryResult","results","queryArgs","path","length","connection","totalCount","internal","connectionType","edges","node","type","module","exports","types","connections","each","name","nodes","typeName","nodeType","nodeObjectType","connectionFields","typeConnection","inferredInputFieldsFromNodes","inferredInputFieldsFromPlugins","fields","fieldsFromPlugins","filterFields","merge","inferredFields","sortNames","sort","concat","camelCase","description","args","filter","resolve","object","b","rootValue","firstOnly","gqlType"],"mappings":"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","sourcesContent":["// @flow\nconst _ = require(`lodash`)\nconst { connectionArgs, connectionDefinitions } = require(`graphql-skip-limit`)\nconst { GraphQLInputObjectType } = require(`graphql`)\nconst {\n  inferInputObjectStructureFromNodes,\n} = require(`./infer-graphql-input-fields`)\nconst {\n  inferInputObjectStructureFromFields,\n} = require(`./infer-graphql-input-fields-from-fields`)\nconst createSortField = require(`./create-sort-field`)\nconst buildConnectionFields = require(`./build-connection-fields`)\nconst createPageDependency = require(`../redux/actions/add-page-dependency`)\nconst { connectionFromArray } = require(`graphql-skip-limit`)\nconst { runQuery } = require(`../db/nodes`)\n\nfunction handleQueryResult({ results, queryArgs, path }) {\n  if (results && results.length) {\n    const connection = connectionFromArray(results, queryArgs)\n    connection.totalCount = results.length\n\n    if (results[0].internal) {\n      const connectionType = connection.edges[0].node.internal.type\n      createPageDependency({\n        path,\n        connection: connectionType,\n      })\n    }\n    return connection\n  } else {\n    return null\n  }\n}\n\nmodule.exports = (types: any) => {\n  const connections = {}\n\n  _.each(types, (type /* , fieldName*/) => {\n    // Don't create a connection for the Site node since there can only be one\n    // of them.\n    if (type.name === `Site`) {\n      return\n    }\n    const nodes = type.nodes\n    const typeName = `${type.name}Connection`\n    const { connectionType: typeConnection } = connectionDefinitions({\n      nodeType: type.nodeObjectType,\n      connectionFields: () => buildConnectionFields(type),\n    })\n\n    const inferredInputFieldsFromNodes = inferInputObjectStructureFromNodes({\n      nodes,\n      typeName,\n    })\n\n    const inferredInputFieldsFromPlugins = inferInputObjectStructureFromFields({\n      fields: type.fieldsFromPlugins,\n      typeName,\n    })\n\n    const filterFields = _.merge(\n      {},\n      inferredInputFieldsFromNodes.inferredFields,\n      inferredInputFieldsFromPlugins.inferredFields\n    )\n    const sortNames = inferredInputFieldsFromNodes.sort.concat(\n      inferredInputFieldsFromPlugins.sort\n    )\n    const sort = createSortField(typeName, sortNames)\n\n    connections[_.camelCase(`all ${type.name}`)] = {\n      type: typeConnection,\n      description: `Connection to all ${type.name} nodes`,\n      args: {\n        ...connectionArgs,\n        sort,\n        filter: {\n          type: new GraphQLInputObjectType({\n            name: _.camelCase(`filter ${type.name}`),\n            description: `Filter connection on its fields`,\n            fields: () => filterFields,\n          }),\n        },\n      },\n      async resolve(object, queryArgs, b, { rootValue }) {\n        let path\n        if (typeof rootValue !== `undefined`) {\n          path = rootValue.path\n        }\n        const results = await runQuery({\n          queryArgs,\n          firstOnly: false,\n          gqlType: type.node.type,\n        })\n        return handleQueryResult({ results, queryArgs, path })\n      },\n    }\n  })\n\n  return connections\n}\n"],"file":"build-node-connections.js"}